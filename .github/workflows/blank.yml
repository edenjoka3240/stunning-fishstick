name: Tmate Session

on:
  workflow_dispatch:
  repository_dispatch:
    types: [start-tmate]

jobs:
  tmate-session:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    continue-on-error: true
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y -qq tmate curl wget git net-tools
        tmate -V
        echo "All dependencies installed"

    - name: Start sshx.io + tmate sessions
      run: |
        #============================
        # 1. Khá»Ÿi Ä‘á»™ng SSHX.IO
        #============================
        echo "Starting sshx.io..."
        curl -sSf https://sshx.io/get | sh -s run > /tmp/sshx_output.txt 2>&1 &
        SSHX_PID=$!

        # Äá»£i sshx khá»Ÿi táº¡o vÃ  láº¥y URL
        sleep 10
        SSHX_URL=""
        for i in $(seq 1 12); do
          SSHX_URL=$(grep -oP 'https://sshx\.io/s/[^\s]+' /tmp/sshx_output.txt | head -1)
          if [ -n "$SSHX_URL" ]; then
            break
          fi
          sleep 5
        done

        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘        ðŸŒ SSHX.IO (Web Terminal)        â•‘"
        echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
        if [ -n "$SSHX_URL" ]; then
          echo "â•‘  Má»Ÿ link nÃ y trÃªn trÃ¬nh duyá»‡t:          â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "  ðŸ‘‰ $SSHX_URL"
        else
          echo "â•‘  KhÃ´ng láº¥y Ä‘Æ°á»£c URL, check log:         â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          cat /tmp/sshx_output.txt
        fi
        echo ""

        #============================
        # 2. Khá»Ÿi Ä‘á»™ng TMATE
        #============================
        echo "Starting tmate..."
        tmate -S /tmp/tmate.sock new-session -d
        sleep 5
        tmate -S /tmp/tmate.sock wait tmate-ready

        TMATE_SSH=$(tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}')
        TMATE_WEB=$(tmate -S /tmp/tmate.sock display -p '#{tmate_web}')
        TMATE_SSH_RO=$(tmate -S /tmp/tmate.sock display -p '#{tmate_ssh_ro}')
        TMATE_WEB_RO=$(tmate -S /tmp/tmate.sock display -p '#{tmate_web_ro}')

        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘        ðŸ”‘ TMATE (SSH Terminal)           â•‘"
        echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
        echo "â•‘  SSH:                                    â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  ðŸ‘‰ $TMATE_SSH"
        echo ""
        echo "  ðŸŒ Web: $TMATE_WEB"
        echo ""
        echo "  ðŸ”’ SSH Read-Only: $TMATE_SSH_RO"
        echo "  ðŸ”’ Web Read-Only: $TMATE_WEB_RO"
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘  âœ… Cáº£ 2 session Ä‘ang cháº¡y!             â•‘"
        echo "â•‘  DÃ¹ng sshx.io (trÃ¬nh duyá»‡t) cho dá»… xÃ i  â•‘"
        echo "â•‘  Hoáº·c dÃ¹ng tmate SSH cho terminal        â•‘"
        echo "â•‘  Session má»Ÿ trong ~350 phÃºt              â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

        # Giá»¯ cáº£ 2 session má»Ÿ
        while true; do
          # Kiá»ƒm tra tmate cÃ²n sá»‘ng khÃ´ng
          if ! tmate -S /tmp/tmate.sock has-session 2>/dev/null; then
            echo "Tmate session ended."
            break
          fi
          # Kiá»ƒm tra sshx cÃ²n sá»‘ng khÃ´ng
          if ! kill -0 $SSHX_PID 2>/dev/null; then
            echo "sshx.io session ended, restarting..."
            curl -sSf https://sshx.io/get | sh -s run > /tmp/sshx_output.txt 2>&1 &
            SSHX_PID=$!
          fi
          sleep 60
        done
      timeout-minutes: 350
